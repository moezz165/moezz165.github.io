<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELEGANZA - Kundvagn</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        .cart-item button {
            margin-left: 10px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #555;
        }

        /* Styling för popup-meddelandet */
        #dynamic-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .produkt-köpt {
            opacity: 1 !important;
        }
    </style>
</head>

<body>
    <header class="sido-runrik">
        <h1 class="brand">ELEGANZA</h1>
        <p class="slogan">DRESS FOR CONFIDENCE</p>
    </header>
<script src="navbar.js" defer></script>
    </nav>
    <main class="intruduktion">
        <h2>Din kundvagn</h2>
        
        <div id="cart-items-container"></div>
        
        <p id="total">Total: 0kr</p>
        <button class="btn" id="clear-cart">Töm kundvagn</button>
        <a class="btn" href="betalning.html">Gå till betalning</a>
    </main>
    <br><br><br>
    <br><br><br>
    <br><br><br>
    <br><br><br>
    <br><br><br>
    <br><br><br>
<script src="footer.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const CART_STORAGE_KEY = 'shoppingCart';
            const cartItemsDiv = document.getElementById('cart-items-container');
            const totalP = document.getElementById('total');

            function getCart() {
                try {
                    const cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY));
                    return Array.isArray(cart) ? cart : [];
                } catch (e) {
                    return [];
                }
            }

            function saveCart(cart) {
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
                renderCart();
            }

            function showPopup(message, className) {
                const existingPopup = document.getElementById('dynamic-popup');
                if (existingPopup) existingPopup.remove();

                const popup = document.createElement('div');
                popup.id = 'dynamic-popup';
                popup.classList.add(className);
                popup.innerHTML = message;
                document.body.appendChild(popup);

                setTimeout(() => {
                    popup.remove();
                }, 3000);
            }

            function renderCart() {
                const cart = getCart();
                cartItemsDiv.innerHTML = "";
                let total = 0;

                if (cart.length === 0) {
                    cartItemsDiv.innerHTML = "<p>Kundvagnen är tom.</p>";
                } else {
                    cart.forEach((item, index) => {
                        // Kontrollera om priset är en sträng (t.ex. "299 SEK") och konvertera
                        let priceValue = parseFloat((item.price || '0').toString().replace(' SEK', '').replace(',', '.'));
                        let itemQuantity = item.quantity || 1;
                        
                        total += priceValue * itemQuantity;

                        const itemDiv = document.createElement("div");
                        itemDiv.className = "cart-item";
                        itemDiv.innerHTML = `
                            <span>${itemQuantity} x ${item.name} (${item.color || ''}, ${item.size || ''}) - ${(priceValue * itemQuantity).toFixed(2)}kr</span>
                            <button onclick="removeItem(${index})">Ta bort</button>
                        `;
                        cartItemsDiv.appendChild(itemDiv);
                    });
                }
                totalP.textContent = `Total: ${total.toFixed(2)}kr`;
            }

            window.removeItem = function(index) {
                let cart = getCart();
                cart.splice(index, 1);
                saveCart(cart);
            }

            document.getElementById("clear-cart").addEventListener("click", () => {
                saveCart([]);
            });


            const productForm = document.getElementById('productForm');
            const popup = document.getElementById('popup');

            if (productForm) {
                productForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const cart = getCart();
                    cart.push({ id: Date.now(), name: "Generisk produkt", quantity: 1, price: 100.00 });
                    saveCart(cart);

                    if (popup) {
                        popup.textContent = 'Produkt lades till i kundvagnen.';
                        popup.classList.add('show');

                        setTimeout(() => {
                            popup.classList.remove('show');
                        }, 3000);
                    }
                });
            }

            document.querySelectorAll('.farg-knapp').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.farg-knapp').forEach(btn => btn.classList.remove('aktiv'));
                    this.classList.add('aktiv');

                    const valdFargElement = document.getElementById('vald-farg');
                    if (valdFargElement) {
                        valdFargElement.textContent = this.dataset.farg;
                    }
                });
            });

            document.querySelectorAll('.storlek-knapp').forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', function() {
                        document.querySelectorAll('.storlek-knapp').forEach(btn => btn.classList.remove('aktiv'));
                        this.classList.add('aktiv');
                    });
                }
            });

            const addToCartButtonNew = document.querySelector('.btn-laggtill');
            if (addToCartButtonNew) {
                addToCartButtonNew.addEventListener('click', function() {
                    const selectedSize = document.querySelector('.storlek-knapp.aktiv');
                    const selectedColor = document.querySelector('.farg-knapp.aktiv');
                    const productTitle = document.querySelector('.produkt-titel')?.textContent || 'Okänd Produkt';
                    let productPrice = document.querySelector('.produkt-pris')?.textContent || '0 SEK';

                    if (!selectedSize || !selectedColor) {
                        alert('Vänligen välj både färg och storlek innan du lägger till i kundvagnen.');
                        return;
                    }

                    // Försöker parsa priset till ett nummer
                    let parsedPrice = parseFloat(productPrice.toString().replace(' SEK', '').replace(',', '.'));
                    if (isNaN(parsedPrice)) parsedPrice = 0;


                    const item = {
                        id: Date.now(),
                        name: productTitle,
                        size: selectedSize.textContent.trim(),
                        color: selectedColor.dataset.farg,
                        price: parsedPrice,
                        quantity: 1
                    };

                    const cart = getCart();
                    cart.push(item);
                    saveCart(cart);

                    showPopup('Produkten har lagts till i kundvagnen!', 'produkt-köpt');
                });
            }

            const payform = document.querySelector('.payform');
            if (payform) {
                payform.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const emailInput = payform.querySelector('input[type="email"]');
                    const userEmail = emailInput ? emailInput.value : 'okänd@email.com';

                    if (!emailInput || emailInput.value.trim() === '') {
                        alert('Vänligen ange din e-postadress.');
                        return;
                    }

                    if (getCart().length === 0) {
                        showPopup('Din kundvagn är tom. Lägg till produkter först.', 'produkt-köpt');
                        return;
                    }

                    localStorage.removeItem(CART_STORAGE_KEY);
                    renderCart();

                    const successMessage = `Tack för din betalning! En bekräftelse skickas till ${userEmail}.`;
                    showPopup(successMessage, 'produkt-köpt');

                    if (emailInput) {
                        emailInput.value = '';
                    }
                });
            }
            
            renderCart();
        });
    </script>
</body>

</html>